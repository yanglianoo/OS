# OS开发
- 开发环境：
    - `ubuntu20.04.5 WSL`
    - `sudo apt install nasm`:安装汇编编译器 nasm
    - `sudo apt install bochs-x`:安装虚拟机 bochs
    - `sudo apt-get install qemu-system`   #下载安装可以模拟全部硬件的qemu
    - `sudo apt install gdb` 安装gdb调试器
    - `sudo apt-get install gcc-multilib`&&`sudo apt-get install g++-multilib` 安装在64位的机器上产生32位的程序

- 参考书籍:
    - 操作系统真相还原
    - 30天自制操作系统
    - Orange'S:一个操作系统的实现

**常用寄存器：**

![image-20230128173803324](image/image-20230128173803324.png)

| 16位寄存器 |      功能      | 高8位 | 低8位 |
| :--------: | :------------: | ----- | ------ |
|     AX     |   累加寄存器   | AH    | AL     |
|     CX     |   计数寄存器   | CH    | CL     |
|     DX     |   数据寄存器   | DH    | DL     |
|     BX     |   基址寄存器   | BH    | BL     |
|     SP     |  栈指针寄存器  |       |        |
|     BP     |  基指针寄存器  |       |        |
|     SI     |  源变址寄存器  |       |        |
|     DI     | 目的变址寄存器 |       |        |

- `EAX，ECX，EDX，EBX，ESP，EBP，ESI，EDI `为32位寄存器，寓意为`Extend`，在16位寄存器前加`E`。

| 段寄存器 |     功能     |
| :------: | :----------: |
|    ES    | 附件段寄存器 |
|    CS    | 代码段寄存器 |
|    SS    |  栈段寄存器  |
|    DS    | 数据段寄存器 |
|    FS    |   没有名称   |
|    GS    |   没有名称   |       


`EIP`:  指令寄存器   
 - EIP寄存器是x86架构中的一个寄存器，它存储着下一条指令的地址。EIP寄存器的全称是“Extended Instruction Pointer”，它是一个32位的寄存器，在64位的x86架构中被称为RIP寄存器。
 - 当CPU执行一条指令时，它会从EIP寄存器中读取下一条指令的地址，然后将指令的操作码加载到指令寄存器中，执行指令。当指令执行完毕时，CPU会将EIP寄存器更新为下一条指令的地址，继续执行下一条指令。    

`ESP`:  栈指针寄存器       
 - ESP寄存器是一个栈指针寄存器，用于存储堆栈的当前地址。堆栈是一个LIFO（Last In First Out）结构，它用于在程序执行期间存储临时数据。在函数调用时，参数、返回地址以及一些其他的局部变量都会被压入堆栈中。ESP寄存器的值将指向堆栈顶部，因此可以方便地访问最近的数据。
 - ESP寄存器还用于管理栈的大小。当数据被压入堆栈中时，ESP寄存器的值将减小，当数据被弹出堆栈时，ESP寄存器的值将增加。当ESP寄存器的值达到一定阈值时，将会引发栈溢出错误，这通常会导致程序崩溃。  

 `EBP`:  栈帧寄存器
 - EBP寄存器通常被用作栈帧指针，用于存储当前函数的栈帧的底部地址。栈帧是堆栈中存储当前函数的参数和局部变量的一部分，它在函数调用时动态地分配和释放。使用EBP寄存器作为栈帧指针可以方便地访问函数参数和局部变量。
 - 在函数调用时，EBP寄存器的值将被压入堆栈中，随后将EBP寄存器的值设置为当前堆栈指针的值，以便在函数执行期间可以访问函数参数和局部变量。在函数返回时，EBP寄存器的值将被弹出堆栈中，并将堆栈指针设置为EBP的值，以便恢复调用函数的堆栈指针。
 - 在汇编语言中，可以使用EBP寄存器来访问函数参数和局部变量。例如，使用"mov"指令将EBP寄存器的值复制到另一个寄存器中，然后通过指定偏移量来访问特定参数和局部变量。在C语言中，EBP寄存器被编译器用于处理函数的参数和局部变量。

**栈帧**：操作系统会为每个函数分配一段内存，这个内存就叫做栈帧，ebp维护栈帧栈顶位置为高地址，esp维护栈帧低地址，栈帧中存放着该函数的局部变量以及上一个调用函数的返回地址。访问局部变量时可以通过 [ebp + 偏移] 的方式。
![](./image/5.png)


## 常用汇编指令 x86
 - `equ`: equ是nasm提供的伪指令，意为equal，即等于，指令格式为：符号名称 equ 表达式
 - `dw`：word，双字节，写入双字节即16个bit
 - `db`：bite，单字节，写入单字节即8个bit
 - `dword`: double word,四个字节，32bit
 - `org`: 伪指令，规定程序的起始地址，若不指定则程序默认从`0000h`开始
## 杂项
 - **可重定位文件和可执行文件**：在linux下`.o`和`.bin`文件都是`elf`格式。
各个符号的地址都是0，而且有的符号还是未定义的。地址为0是因为，在没有链接之前，各个可重定位文件是独立的，他们无法加载到内存中去执行，各个符号还没有进行重定位。而有的符号未定义是因为该文件中引用了外部文件的代码或者数据。    
 - **C语言内联汇编**:    
    ```c
    #define __asm__ asm  
    __asm__　__volatile__("InSTructiON List" : Output : Input : Clobber/Modify);
    //例如
    asm volatile("lgdt gdt_ptr\n");
    ```
    `volatile`是为了告诉编译器后面的代码不能被优化，直接一步步执行